# ユーザー管理機能ガイド

## 概要

管理者は以下のユーザー管理機能を利用できます：

1. **ユーザー一覧表示** - 全ユーザーの情報を一覧表示
2. **ユーザー詳細表示** - 個別ユーザーの詳細情報と診断履歴を表示
3. **ユーザー情報編集** - ユーザー名、メール、ロール、状態の変更
4. **ユーザー削除** - ユーザーアカウントの削除

## アクセス方法

### 管理者権限が必要

ユーザー管理機能は**管理者ロール**を持つユーザーのみがアクセスできます。

1. 管理者アカウントでログイン
2. ナビゲーションバーの「管理画面」をクリック
3. 管理ダッシュボードから「ユーザー一覧」をクリック

または、直接URLにアクセス：
- ユーザー一覧: `http://localhost:5000/admin/users`

## 機能詳細

### 1. ユーザー一覧表示

**URL**: `/admin/users`

**表示内容**:
- ユーザーID
- ユーザー名
- メールアドレス
- ロール（管理者/一般）
- アカウント状態（有効/無効）
- 登録日
- 最終ログイン日時
- 診断実施回数

**操作ボタン**:
- 🔵 **詳細** - ユーザー詳細ページへ移動
- 🔴 **削除** - ユーザーを削除（自分自身は削除不可）

### 2. ユーザー詳細表示

**URL**: `/admin/users/<user_id>`

**表示内容**:

#### 左側：編集フォーム
- ユーザー名の変更
- メールアドレスの変更
- ロールの変更（一般ユーザー/管理者）
- アカウント状態の変更（有効/無効）
- パスワードの変更（任意）

#### 右側：ユーザー情報サマリー
- ユーザーID
- 現在のロール
- アカウント状態
- 登録日時
- 最終ログイン日時
- 診断実施回数

#### 下部：診断履歴
- 診断日時
- MBTIタイプ
- 各軸のスコア

### 3. ユーザー情報編集

**URL**: `/admin/users/<user_id>/edit` (POST)

**編集可能な項目**:
- ユーザー名
- メールアドレス
- ロール（管理者/一般ユーザー）
- アカウント状態（有効/無効）
- パスワード（変更する場合のみ入力）

**制限事項**:
- 自分自身の管理者権限は削除できません
- 自分自身のアカウントは無効化できません

**操作手順**:
1. ユーザー詳細ページで情報を編集
2. 「保存」ボタンをクリック
3. 成功メッセージが表示され、詳細ページにリダイレクト

### 4. ユーザー削除

**URL**: `/admin/users/<user_id>/delete` (POST)

**削除の影響**:
- ユーザーアカウントが完全に削除されます
- 関連する診断結果も削除される可能性があります（データベース設定による）
- **この操作は取り消せません**

**制限事項**:
- 自分自身のアカウントは削除できません

**操作手順**:

#### 方法1: ユーザー一覧から削除
1. ユーザー一覧で削除したいユーザーの「削除」ボタンをクリック
2. 確認ダイアログで「OK」をクリック

#### 方法2: ユーザー詳細から削除
1. ユーザー詳細ページの右側「危険な操作」カードを確認
2. 「このユーザーを削除」ボタンをクリック
3. 確認ダイアログで「OK」をクリック

## 安全機能

### 自己保護機能
以下の操作は**自分自身に対して実行できません**：

1. ✅ 自分の管理者権限の削除 → 防止
2. ✅ 自分のアカウントの無効化 → 防止
3. ✅ 自分のアカウントの削除 → 防止

### 確認ダイアログ
- ユーザー削除時には**確認ダイアログ**が表示されます
- 誤操作を防ぐため、ユーザー名も表示されます

### フラッシュメッセージ
すべての操作結果は、画面上部にフラッシュメッセージとして表示されます：
- ✅ **成功** - 緑色のメッセージ
- ⚠️ **警告** - 黄色のメッセージ
- ❌ **エラー** - 赤色のメッセージ

## 使用例

### 例1: 新規ユーザーのロールを管理者に変更

1. `/admin/users` にアクセス
2. 対象ユーザーの「詳細」ボタンをクリック
3. ロールのドロップダウンから「管理者」を選択
4. 「保存」ボタンをクリック
5. 成功メッセージを確認

### 例2: 休眠ユーザーを無効化

1. `/admin/users` にアクセス
2. 対象ユーザーの「詳細」ボタンをクリック
3. 「アカウントを有効化」のチェックを外す
4. 「保存」ボタンをクリック
5. ユーザーはログインできなくなります

### 例3: パスワードをリセット

1. `/admin/users` にアクセス
2. 対象ユーザーの「詳細」ボタンをクリック
3. 「新しいパスワード」フィールドに新しいパスワードを入力
4. 「保存」ボタンをクリック
5. 新しいパスワードでログイン可能になります

### 例4: 不要なアカウントを削除

1. `/admin/users` にアクセス
2. 対象ユーザーの「削除」ボタンをクリック
3. 確認ダイアログで「OK」をクリック
4. ユーザーが削除されます

## トラブルシューティング

### 「自分自身の管理者権限は削除できません」と表示される

**原因**: 自分のアカウントの管理者権限を削除しようとしています

**解決策**: 別の管理者アカウントでログインして変更するか、操作を中止してください

### 「自分自身のアカウントは削除できません」と表示される

**原因**: 自分のアカウントを削除しようとしています

**解決策**: 別の管理者アカウントでログインして削除するか、操作を中止してください

### 「エラーが発生しました」と表示される

**原因**: データベースエラーやバリデーションエラーが発生しました

**解決策**: 
1. 入力内容を確認（メールアドレスの形式など）
2. ログを確認: `docker logs mbti-app`
3. データベースの状態を確認

## セキュリティ上の注意

### 管理者権限の付与
- 管理者権限は**信頼できるユーザーにのみ**付与してください
- 管理者は**すべてのユーザー情報にアクセス**できます
- 管理者は**他のユーザーを削除**できます

### パスワードの変更
- パスワードは**6文字以上**を推奨
- 変更後のパスワードは**ユーザーに安全に伝達**してください
- パスワードは暗号化されて保存されます（werkzeug.security使用）

### アカウントの無効化 vs 削除
- **無効化**: ログインできなくなりますが、データは保持されます
- **削除**: アカウントとデータが完全に削除されます

**推奨**: 一時的にアクセスを制限する場合は「無効化」を使用してください

## API仕様（開発者向け）

### ユーザー一覧
```
GET /admin/users
Response: HTML (users.html)
Required: @admin_required
```

### ユーザー詳細
```
GET /admin/users/<int:user_id>
Response: HTML (user_detail.html)
Required: @admin_required
```

### ユーザー編集
```
POST /admin/users/<int:user_id>/edit
Parameters:
  - username: string (required)
  - email: string (required)
  - role: string (user|admin, required)
  - is_active: checkbox (on|off)
  - new_password: string (optional)
Response: Redirect to user_detail
Required: @admin_required
```

### ユーザー削除
```
POST /admin/users/<int:user_id>/delete
Response: Redirect to admin_users
Required: @admin_required
Restrictions: Cannot delete self
```

## 関連ファイル

- `app.py` - ユーザー管理ルート定義
- `database.py` - Userモデル定義
- `templates/admin/users.html` - ユーザー一覧テンプレート
- `templates/admin/user_detail.html` - ユーザー詳細テンプレート

---

**注意**: このアプリケーションは教育目的で開発されており、本番環境での使用は推奨されません。

